https://raw.githubusercontent.com/Azure/azure-rest-api-specs/main/specification/cognitiveservices/data-plane/AzureOpenAI/inference/preview/2024-02-15-preview/inference.json

requests
| where timestamp > ago(1h) // Adjust the time range as needed
| where resultCode == "404" // Filter for 'Not Found' errors
| where url has "chat/completions" or name has "chat/completions" // Narrow down to LLM calls
| project 
    TimeGenerated = timestamp,
    OperationName = name,
    RequestURL = url, 
    ResponseCode = resultCode, 
    DurationMs = duration,
    ClientIP = client_IP,
    // Extract headers if they were successfully captured in custom dimensions
    UserAgent = customDimensions["User-Agent"],
    Host = customDimensions["Host"]
| order by TimeGenerated desc

<inbound>
    <base />
    
    <choose>
        <when condition="@(context.Request.Url.Path.Contains("/v1/chat/completions"))">
            <rewrite-uri template="/openai/deployments/YOUR_DEPLOYMENT_NAME/chat/completions?api-version=2023-05-15" />
        </when>
    </choose>

    <choose>
        <when condition="@(context.Request.Headers.ContainsKey("Authorization"))">
            <set-header name="api-key" exists-action="override">
                <value>@(context.Request.Headers.GetValueOrDefault("Authorization", "").Replace("Bearer ", ""))</value>
            </set-header>
            <set-header name="Ocp-Apim-Subscription-Key" exists-action="override">
                <value>@(context.Request.Headers.GetValueOrDefault("Authorization", "").Replace("Bearer ", ""))</value>
            </set-header>
            <set-header name="Authorization" exists-action="delete" />
        </when>
    </choose>
</inbound>

<inbound>
    <base />

    <set-variable name="requestedModel" value="@{
        var body = context.Request.Body.As<JObject>(preserveContent: true);
        return (string)body["model"];
    }" />

    <choose>
        <when condition="@(context.Request.Url.Path.Contains("/v1/chat/completions"))">
            <rewrite-uri template="@("/openai/deployments/" + context.Variables["requestedModel"] + "/chat/completions?api-version=2023-05-15")" />
        </when>
    </choose>

    <choose>
        <when condition="@(context.Request.Headers.ContainsKey("Authorization"))">
            <set-header name="api-key" exists-action="override">
                <value>@(context.Request.Headers.GetValueOrDefault("Authorization", "").Replace("Bearer ", ""))</value>
            </set-header>
            <set-header name="Ocp-Apim-Subscription-Key" exists-action="override">
                <value>@(context.Request.Headers.GetValueOrDefault("Authorization", "").Replace("Bearer ", ""))</value>
            </set-header>
            <set-header name="Authorization" exists-action="delete" />
        </when>
    </choose>
</inbound>


<inbound>
    <base />

    <set-variable name="requestedModel" value="@{
        var body = context.Request.Body.As<JObject>(preserveContent: true);
        return (string)body["model"];
    }" />

    <choose>
        <when condition="@(context.Request.Url.Path.Contains("/v1/chat/completions"))">
            <rewrite-uri template="@("/openai/deployments/" + context.Variables["requestedModel"] + "/chat/completions?api-version=2023-05-15")" />
        </when>
    </choose>

    <set-header name="api-key" exists-action="override">
        <value>{{azure-openai-backend-key}}</value>
    </set-header>

    <set-header name="Authorization" exists-action="delete" />
</inbound>
